{% extends 'base.html' %}

{% block head %}
<title>Booking - Réservations installations sportives IMT Atlantique</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/booking.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/calendar.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/navbar_booking.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/plan_booking.css') }}">
{% endblock %}

{% block body %}

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Réservations IMT</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav">
                <a class="nav-link" href="#reserve-section">Réserver</a>
                <a class="nav-link" href="#timetable-section">Consulter les réservations</a>
                <a class="nav-link" href="#reservations-list">Mes réservations</a>
                <a class="nav-link ms-auto" href="{{ url_for('logout') }}">Déconnexion</a>
            </div>
        </div>
    </div>
</nav>


<!-- Building Plan -->
<div class="container mt-5">
    <!-- First Column (Top Half) -->
    <div class="column">
        <div class="top-half">
            {% for place in gym_places[:gym_places|length//2] %}
                <div class="card w-100 text-center align-items-center d-flex justify-content-center" data-value="{{ place }}">
                    <div class="card-body">
                        <div class="h3">{{ place }}</div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    <!-- Second Column (Bottom Half) -->
    <div class="column">
        <div class="bottom-half">
            {% for place in gym_places[gym_places|length//2:] %}
                <div class="card w-100 text-center align-items-center d-flex justify-content-center" data-value="{{ place }}">
                    <div class="card-body">
                        <div class="h3">{{ place }}</div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>



<!-- Place Selection for Timetable -->
<div class="container mt-5" id="timetable-section">
    <h2 class="mb-4">Consulter les horaires</h2>
    <form id="placeSelectionForm">
        <div class="mb-3">
            <label for="timetablePlace" class="form-label">Choisir l'endroit pour consulter les horaires</label>
            <select class="form-select" id="timetablePlace" name="timetable_place">
                <option value="">Sélectionner un endroit</option>
                {% for place in gym_places %}
                <option value="{{ place }}">{{ place }}</option>
                {% endfor %}
            </select>
        </div>
    </form>
    <div id="timetable"></div>
</div>

<!-- Calendar -->
<div lass="container mt-5" id="calendrier">
    <h2>Calendar</h2>
        <div class="calendar">
          <header>
            <h3 id="currentMonthTitle"></h3>
            <nav>
              <button id="prev"></button>
              <button id="next"></button>
            </nav>
          </header>
          <section>
            <ul class="days">
              <li>Sun</li>
              <li>Mon</li>
              <li>Tue</li>
              <li>Wed</li>
              <li>Thu</li>
              <li>Fri</li>
              <li>Sat</li>
            </ul>
            <ul class="dates"></ul>
          </section>
        </div>
        <!-- Modal Overlay -->
    <div id="modal-overlay"></div>

    <!-- Popup Modal -->
    <div id="timetable-container" style="display: none;">
        <h3 id="selected-date">Selected Day: </h3>
        <table id="timetable">
            <!-- Timetable will be dynamically generated here -->
        </table>
    </div>
</div>

<!-- Reservation Form -->
<div class="container mt-5" id="reserve-section">
    <h2 class="mb-4">Réserver</h2>
    <form action="{{ url_for('create_reservation') }}" method="post">
        <div class="mb-3">
            <label for="bookedPlace" class="form-label">Choisir l'endroit</label>
            <select class="form-select" id="bookedPlace" name="booked_place" required>
                {% for place in gym_places %}
                <option value="{{ place }}">{{ place }}</option>
            {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label for="reservationDate" class="form-label">Date de Reservation</label>
            <input type="date" class="form-control" id="reservationDate" name="date_of_reservation" required>
        </div>
        <div class="mb-3">
            <label for="startTime" class="form-label">Heure de début</label>
            <select class="form-select" id="startTime" name="time_of_reservation" required>
                {% for hour in range(6, 24) %}
                    <option value="{{ '%02d' % hour }}:{{ '%02d' % 00 }}">{{ '%02d' % hour }}:{{ '%02d' % 00 }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label for="endTime" class="form-label">Heure de fin</label>
            <select class="form-select" id="endTime" name="end_time_of_reservation" required>
                {% for hour in range(7, 25) %}
                    <option value="{{ '%02d' % hour }}:{{ '%02d' % 00 }}">{{ '%02d' % hour }}:{{ '%02d' % 00 }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Confirmer Réservation</button>
    </form>
</div>


<!-- Reservations List -->
<div class="container mt-5" id="reservations-list">
    {% if current_user.is_authenticated and current_user.is_admin %}
    <div class="admin-link">
        <a href="{{ url_for('admin_reservations') }}" class="btn btn-primary">Admin Réservations</a>
    </div>
    {% endif %}
    <h2 class="mb-4">Vos Réservations</h2>
    <table class="table" id="reservationsTable">
        <thead>
            <tr>
                <!-- ... table headers ... -->
            </tr>
        </thead>
        <tbody>
            {% for reservation in reservations %}
            <tr data-id="{{ reservation.id }}">
                <td class="booked-place">{{ reservation.booked_place }}</td>
                <td class="date-of-reservation">{{ reservation.date_of_reservation }}</td>
                <td class="start-time">{{ reservation.time_of_reservation.strftime('%H:%M') }}</td>
                <td class="end-time">{{ reservation.end_time_of_reservation.strftime('%H:%M') }}</td>
                <td>
                    <button type="button" onclick="updateReservation(this.closest('tr'))" class="btn btn-secondary">Update</button>
                    <button type="button" onclick="deleteReservation(this.closest('tr').getAttribute('data-id'))" class="btn btn-danger">Delete</button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5">Aucune réservations trouvée.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Update Reservation Modal -->
<div class="modal fade" id="updateReservationModal" tabindex="-1" aria-labelledby="updateReservationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="updateReservationModalLabel">Modifier réservation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Update form -->
          <form id="updateReservationForm">
            <input type="hidden" id="updateReservationId">
            <div class="mb-3">
              <label for="updateBookedPlace" class="form-label">Choisir l'endoit</label>
              <select class="form-select" id="updateBookedPlace" required>
                {% for place in gym_places %}
                <option value="{{ place }}">{{ place }}</option>
            {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="updateReservationDate" class="form-label">Date de Reservation</label>
              <input type="date" class="form-control" id="updateReservationDate" required>
            </div>
            <div class="mb-3">
              <label for="updateStartTime" class="form-label">Heure de début</label>
              <input type="time" class="form-control" id="updateStartTime" required>
            </div>
            <div class="mb-3">
              <label for="updateEndTime" class="form-label">Heure de fin</label>
              <input type="time" class="form-control" id="updateEndTime" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
          <button type="button" class="btn btn-primary" onclick="submitUpdateReservation()">Enregistrer les modifications</button>
        </div>
      </div>
    </div>
  </div>

<script src="{{ url_for('static', filename='js/reservations.js') }}"></script>



<script>
const header = document.querySelector(".calendar h3");
const dates = document.querySelector(".dates");
const navs = document.querySelectorAll("#prev, #next");

const months = [
  "January",
  "February",
  "March",
  "April",
  "May",
  "June",
  "July",
  "August",
  "September",
  "October",
  "November",
  "December",
];

let date = new Date();
let month = date.getMonth();
let year = date.getFullYear();

function renderCalendar() {
  const start = new Date(year, month, 1).getDay();
  const endDate = new Date(year, month + 1, 0).getDate();
  const end = new Date(year, month, endDate).getDay();
  const endDatePrev = new Date(year, month, 0).getDate();

  let datesHtml = "";

  for (let i = start; i > 0; i--) {
    datesHtml += `<li class="inactive">${endDatePrev - i + 1}</li>`;
  }

  for (let i = 1; i <= endDate; i++) {
    let className =
      i === date.getDate() &&
      month === new Date().getMonth() &&
      year === new Date().getFullYear()
        ? ' class="today"'
        : "";
    datesHtml += `<li${className}>${i}</li>`;
  }

  for (let i = end; i < 6; i++) {
    datesHtml += `<li class="inactive">${i - end + 1}</li>`;
  }

  dates.innerHTML = datesHtml;
  header.textContent = `${months[month]} ${year}`;
}


navs.forEach((nav) => {
  nav.addEventListener("click", (e) => {
    const btnId = e.target.id;

    if (btnId === "prev" && month === 0) {
      year--;
      month = 11;
    } else if (btnId === "next" && month === 11) {
      year++;
      month = 0;
    } else {
      month = btnId === "next" ? month + 1 : month - 1;
    }

    date = new Date(year, month, new Date().getDate());
    year = date.getFullYear();
    month = date.getMonth();

    renderCalendar();
  });
});

renderCalendar();


  document.addEventListener("DOMContentLoaded", function () {
    const datesContainer = document.querySelector(".dates");
    const prevButton = document.getElementById("prev");
    const nextButton = document.getElementById("next");
    const selectedDateElem = document.getElementById("selected-date");
    const timetableElem = document.getElementById("timetable");
    const popupModal = document.getElementById("popup-modal");
    const modalOverlay = document.getElementById("modal-overlay");
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    function generateCalendar(month, year) {
        datesContainer.innerHTML = "";
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const headerElem = document.querySelector("header h3");
        headerElem.textContent = new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' });

        for (let i = 0; i < firstDay; i++) {
            datesContainer.appendChild(document.createElement("li"));
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayElem = document.createElement("li");
            dayElem.textContent = day;
            dayElem.addEventListener("click", function () {
                const formattedDate = `${year}-${(month+1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                document.getElementById('reservationDate').value = formattedDate;
                showTimetable(day, month, year); // this function will show the timetable based on selected day
            });
            datesContainer.appendChild(dayElem);
        }
    }



function calendarDayClicked(day, month, year) {
    

    // Now you can call `fetchTimetable` to show the timetable for the chosen place
    fetchTimetable();
}

// Function to trigger showing the timetable with the selected place
function fetchTimetable() {
    
    

    // Ensure that we have valid day, month, and year values
    if (selectedDay === undefined || selectedMonth === undefined || selectedYear === undefined) {
        alert("Please select a day from the calendar.");
        return;
    }

    // Pass the selected day, month, year, and place to the `showTimetable` function
    showTimetable(selectedDay, selectedMonth, selectedYear);
}

async function showTimetable(day, month, year) {
    // Prepare the selected date in a consistent format (YYYY-MM-DD)
    const selectedDate = new Date(year, month, day + 1).toISOString().slice(0, 10);
    const timetableElem = document.getElementById("timetable");

    timetableElem.innerHTML = "";
    console.log(day);
    console.log(month);
    console.log(year);
    console.log(selectedDate);

    // Get the selected place value
    const selectedPlaceElem = document.getElementById("timetablePlace");
    const selectedPlace = selectedPlaceElem.value;

    if (selectedPlace === "") {
        alert("Please select a place first.");
        return;
    }

    try {
        // Fetch reservations data from the backend
        const response = await fetch(`/api/reservations?date=${selectedDate}&place=${selectedPlace}`);
        const reservations = await response.json();

        console.log(reservations);

        // Check if the server returned an error
        if (reservations.error) {
            alert(`Error: ${reservations.error}`);
            return;
        }

        // Ensure reservations is an array
        const reservedTimeSlots = Array.isArray(reservations)
            ? reservations.map(r => ({
                start: r.time_of_reservation,
                end: r.end_time_of_reservation
            }))
            : [];

        // Create a timetable with a 6x3 grid of available and booked slots
        const hoursPerRow = 3;
        const totalRows = 6;

        for (let row = 0; row < totalRows; row++) {
            const rowElem = document.createElement("tr"); // Create a row for each set of slots
            for (let slot = 0; slot < hoursPerRow; slot++) {
                const hour = 6 + row * hoursPerRow + slot;
                const startTime = `${hour.toString().padStart(2, '0')}:00`;
                const endTime = `${(hour + 1).toString().padStart(2, '0')}:00`;

                const timeCell = document.createElement("td");
                timeCell.textContent = `${startTime} - ${endTime}`;

                // Check if this time range overlaps with any reserved time slots
                const isBooked = reservedTimeSlots.some(slot => startTime >= slot.start && startTime < slot.end);

                // Assign "booked" or "available" class
                timeCell.classList.add(isBooked ? 'booked' : 'available');
                if (!isBooked) {
                    timeCell.addEventListener('click', () => {
                        document.getElementById('startTime').value = startTime;
                        document.getElementById('endTime').value = endTime;
                    });
                }

                // Append to the row
                rowElem.appendChild(timeCell);
            }

            // Append the row to the timetable
            timetableElem.appendChild(rowElem);
        }

        // Show the modal
        showModal();

    } catch (error) {
        console.error('Error fetching reservations:', error);
    }
}



// Open Modal Logic
function showModal() {
  const popupModal = document.getElementById("popup-modal");
  const modalOverlay = document.getElementById("modal-overlay");
  popupModal.style.display = "block";
  modalOverlay.style.display = "block";
}


    function closeModal() {
        // Hide the modal and overlay
    const popupModal = document.getElementById("popup-modal");
    const modalOverlay = document.getElementById("modal-overlay");
    popupModal.style.display = "none";
    modalOverlay.style.display = "none";

    // Clear the timetable's content
    const timetableElem = document.getElementById("timetable");
    timetableElem.innerHTML = "";
    }

    prevButton.addEventListener("click", function () {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        generateCalendar(currentMonth, currentYear);
    });

    nextButton.addEventListener("click", function () {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        generateCalendar(currentMonth, currentYear);
    });

    window.closeModal = closeModal;
    generateCalendar(currentMonth, currentYear);
});

</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
    const cards = document.querySelectorAll('.card[data-value]');
    const selectField = document.getElementById('timetablePlace');
    const selectFieldTwo = document.getElementById('bookedPlace');

    cards.forEach(card => {
        card.addEventListener('click', function () {
            const value = card.getAttribute('data-value');
            selectField.value = value;
            selectFieldTwo.value = value;
        });
    });
});

</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Array of month names
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        
        // Get the current date
        const now = new Date();
        
        // Get the current month name
        const currentMonth = monthNames[now.getMonth()];
        
        // Update the content of the h3 element
        document.getElementById("currentMonthTitle").textContent = "Month: " + currentMonth;
    });
    </script>


{% endblock %}



